---
import { SHOW_BUY_BUTTON } from "astro:env/server";
import Layout from "../../layouts/Layout.astro";
import AmazonLogo from "../../components/AmazonLogo.astro";
import BookScore from "../../components/BookScore.astro";
import BuyButton from "../../components/BuyButton.astro";

interface APIResponse {
  docs: CursoAPI[];
}

interface CoverImage {
  url: string;
}

export interface CursoAPI {
  id: number;
  slug: string;
  title: string;
  descripcionCurso?: string;
  precio?: number;
  coverImage?: CoverImage;
}

export interface BookData {
  title: string;
  author: string;
  img: string;
  readtime: number;
  description: string;
  buy: number; // <= aquí guardamos un precio "inicial" o lo que quieras
}

export interface Book {
  slug: string;
  data: BookData;
}

export async function getStaticPaths() {
  const res = await fetch("https://admin.nicolascarrillo.com/api/cursos");
  if (!res.ok) {
    throw new Error(`Error al obtener los cursos: ${res.statusText}`);
  }

  const data = (await res.json()) as APIResponse;

  return data.docs.map((curso) => {
    const book: Book = {
      slug: curso.slug,
      data: {
        title: curso.title,
        author: "Autor desconocido",
        img: curso.coverImage?.url ?? "placeholder.webp",
        readtime: 5,
        description: curso.descripcionCurso ?? "Sin descripción",
        buy: curso.precio ?? 0, // este "buy" sería el precio estático en el momento del build
      },
    };

    return {
      params: { id: curso.slug },
      props: { book },
    };
  });
}

const { book } = Astro.props as { book: Book };
const { data, slug } = book;
const { title, author, img, readtime, description, buy } = data;

export const prerender = true;
---

<Layout title={`${title} - Dev Books`}>
  <div class="flex gap-12">
    <aside class="flex flex-col items-center gap-4">
      <a href="/" class="hover:underline opacity-70">← Volver atrás</a>

      <img
        transition:name={`img-${slug}`}
        class="rounded w-72 h-auto"
        src={img}
        alt={title}
      />

      <BookScore server:defer id={slug}>
        <span slot="fallback" class="text-xs opacity-70">
          Cargando puntuación...
        </span>
      </BookScore>

      {
        SHOW_BUY_BUTTON && (
          <!-- 
            Le pasamos el `slug` al BuyButton para que 
            él haga su propio fetch en cada request
          -->
          <BuyButton server:defer slug={slug} />
        )
      }
    </aside>

    <main class="max-w-3xl">
      <h1 transition:name={`title-${slug}`} class="text-4xl font-bold mb-4">
        {title}
      </h1>
      <p class="text-sm opacity-80">Autor: {author}</p>
      <p class="text-sm opacity-80 mb-4">Tiempo de lectura: {readtime} min</p>

      <div class="prose prose-invert">
        {description}
      </div>
    </main>
  </div>
</Layout>